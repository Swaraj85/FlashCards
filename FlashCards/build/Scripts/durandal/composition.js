define(["durandal/system","durandal/viewLocator","durandal/binder","durandal/viewEngine","durandal/activator","jquery","knockout"],function(e,n,t,i,a,r,o){function s(e){for(var n=[],t={childElements:n,activeView:null},i=o.virtualElements.firstChild(e);i;)1==i.nodeType&&(n.push(i),i.getAttribute(X)&&(t.activeView=i)),i=o.virtualElements.nextSibling(i);return t.activeView||(t.activeView=n[0]),t}function u(){S--,0===S&&setTimeout(function(){for(var n=C.length;n--;)try{C[n]()}catch(t){e.error(t)}C=[]},1)}function c(e){delete e.activeView,delete e.viewElements}function l(n,t,i){if(i)t();else if(n.activate&&n.model&&n.model.activate){var a;try{a=e.isArray(n.activationData)?n.model.activate.apply(n.model,n.activationData):n.model.activate(n.activationData),a&&a.then?a.then(t,function(n){e.error(n),t()}):a||void 0===a?t():(u(),c(n))}catch(r){e.error(r)}}else t()}function d(){var n=this;if(n.activeView&&n.activeView.removeAttribute(X),n.child)try{n.model&&n.model.attached&&(n.composingNewView||n.alwaysTriggerAttach)&&n.model.attached(n.child,n.parent,n),n.attached&&n.attached(n.child,n.parent,n),n.child.setAttribute(X,!0),n.composingNewView&&n.model&&n.model.detached&&o.utils.domNodeDisposal.addDisposeCallback(n.child,function(){try{n.model.detached(n.child,n.parent,n)}catch(t){e.error(t)}})}catch(t){e.error(t)}n.triggerAttach=e.noop}function w(n){if(e.isString(n.transition)){if(n.activeView){if(n.activeView==n.child)return!1;if(!n.child)return!0;if(n.skipTransitionOnSameViewId){var t=n.activeView.getAttribute("data-view"),i=n.child.getAttribute("data-view");return t!=i}}return!0}return!1}function f(e){for(var n=0,t=e.length,i=[];t>n;n++){var a=e[n].cloneNode(!0);i.push(a)}return i}function v(e){var n=f(e.parts),t=h.getParts(n,null,!0),i=h.getParts(e.child);for(var a in t)r(i[a]).replaceWith(t[a])}function m(n){var t,i,a=o.virtualElements.childNodes(n.parent);if(!e.isArray(a)){var r=[];for(t=0,i=a.length;i>t;t++)r[t]=a[t];a=r}for(t=1,i=a.length;i>t;t++)o.removeNode(a[t])}function p(e){o.utils.domData.set(e,I,e.style.display),e.style.display="none"}function g(e){e.style.display=o.utils.domData.get(e,I)}function A(e){var n=e.getAttribute("data-bind");if(!n)return!1;for(var t=0,i=x.length;i>t;t++)if(n.indexOf(x[t])>-1)return!0;return!1}var h,Q={},X="data-active-view",C=[],S=0,y="durandal-composition-data",b="data-part",D=["model","view","transition","area","strategy","activationData"],I="durandal-visibility-data",x=["compose:"],V={complete:function(e){C.push(e)}};return h={composeBindings:x,convertTransitionToModuleId:function(e){return"transitions/"+e},defaultTransitionName:null,current:V,addBindingHandler:function(e,n,t){var i,a,r="composition-handler-"+e;n=n||o.bindingHandlers[e],t=t||function(){return void 0},a=o.bindingHandlers[e]={init:function(e,i,a,s,u){if(S>0){var c={trigger:o.observable(null)};h.current.complete(function(){n.init&&n.init(e,i,a,s,u),n.update&&(o.utils.domData.set(e,r,n),c.trigger("trigger"))}),o.utils.domData.set(e,r,c)}else o.utils.domData.set(e,r,n),n.init&&n.init(e,i,a,s,u);return t(e,i,a,s,u)},update:function(e,n,t,i,a){var s=o.utils.domData.get(e,r);return s.update?s.update(e,n,t,i,a):(s.trigger&&s.trigger(),void 0)}};for(i in n)"init"!==i&&"update"!==i&&(a[i]=n[i])},getParts:function(e,n,t){if(n=n||{},!e)return n;void 0===e.length&&(e=[e]);for(var i=0,a=e.length;a>i;i++){var r=e[i];if(r.getAttribute){if(!t&&A(r))continue;var o=r.getAttribute(b);o&&(n[o]=r),!t&&r.hasChildNodes()&&h.getParts(r.childNodes,n)}}return n},cloneNodes:f,finalize:function(n){if(void 0===n.transition&&(n.transition=this.defaultTransitionName),n.child||n.activeView)if(w(n)){var i=this.convertTransitionToModuleId(n.transition);e.acquire(i).then(function(e){n.transition=e,e(n).then(function(){if(n.cacheViews){if(n.activeView){var e=t.getBindingInstruction(n.activeView);e&&void 0!=e.cacheViews&&!e.cacheViews&&o.removeNode(n.activeView)}}else n.child?m(n):o.virtualElements.emptyNode(n.parent);n.triggerAttach(),u(),c(n)})}).fail(function(n){e.error("Failed to load transition ("+i+"). Details: "+n.message)})}else{if(n.child!=n.activeView){if(n.cacheViews&&n.activeView){var a=t.getBindingInstruction(n.activeView);!a||void 0!=a.cacheViews&&!a.cacheViews?o.removeNode(n.activeView):p(n.activeView)}n.child?(n.cacheViews||m(n),g(n.child)):n.cacheViews||o.virtualElements.emptyNode(n.parent)}n.triggerAttach(),u(),c(n)}else n.cacheViews||o.virtualElements.emptyNode(n.parent),n.triggerAttach(),u(),c(n)},bindAndShow:function(e,n,a){n.child=e,n.composingNewView=n.cacheViews?-1==o.utils.arrayIndexOf(n.viewElements,e):!0,l(n,function(){if(n.binding&&n.binding(n.child,n.parent,n),n.preserveContext&&n.bindingContext)n.composingNewView&&(n.parts&&v(n),p(e),o.virtualElements.prepend(n.parent,e),t.bindContext(n.bindingContext,e,n.model));else if(e){var a=n.model||Q,r=o.dataFor(e);if(r!=a){if(!n.composingNewView)return o.removeNode(e),i.createView(e.getAttribute("data-view")).then(function(e){h.bindAndShow(e,n,!0)}),void 0;n.parts&&v(n),p(e),o.virtualElements.prepend(n.parent,e),t.bind(a,e)}}h.finalize(n)},a)},defaultStrategy:function(e){return n.locateViewForObject(e.model,e.area,e.viewElements)},getSettings:function(n){var t,r=n(),s=o.utils.unwrapObservable(r)||{},u=a.isActivator(r);if(e.isString(s))return s=i.isViewUrl(s)?{view:s}:{model:s,activate:!0};if(t=e.getModuleId(s))return s={model:s,activate:!0};!u&&s.model&&(u=a.isActivator(s.model));for(var c in s)s[c]=-1!=o.utils.arrayIndexOf(D,c)?o.utils.unwrapObservable(s[c]):s[c];return u?s.activate=!1:void 0===s.activate&&(s.activate=!0),s},executeStrategy:function(e){e.strategy(e).then(function(n){h.bindAndShow(n,e)})},inject:function(t){return t.model?t.view?(n.locateView(t.view,t.area,t.viewElements).then(function(e){h.bindAndShow(e,t)}),void 0):(t.strategy||(t.strategy=this.defaultStrategy),e.isString(t.strategy)?e.acquire(t.strategy).then(function(e){t.strategy=e,h.executeStrategy(t)}).fail(function(n){e.error("Failed to load view strategy ("+t.strategy+"). Details: "+n.message)}):this.executeStrategy(t),void 0):(this.bindAndShow(null,t),void 0)},compose:function(t,i,a,r){S++,r||(i=h.getSettings(function(){return i},t)),i.compositionComplete&&C.push(function(){i.compositionComplete(i.child,i.parent,i)}),C.push(function(){i.composingNewView&&i.model&&i.model.compositionComplete&&i.model.compositionComplete(i.child,i.parent,i)});var o=s(t);i.activeView=o.activeView,i.parent=t,i.triggerAttach=d,i.bindingContext=a,i.cacheViews&&!i.viewElements&&(i.viewElements=o.childElements),i.model?e.isString(i.model)?e.acquire(i.model).then(function(n){i.model=e.resolveObject(n),h.inject(i)}).fail(function(n){e.error("Failed to load composed module ("+i.model+"). Details: "+n.message)}):h.inject(i):i.view?(i.area=i.area||"partial",i.preserveContext=!0,n.locateView(i.view,i.area,i.viewElements).then(function(e){h.bindAndShow(e,i)})):this.bindAndShow(null,i)}},o.bindingHandlers.compose={init:function(){return{controlsDescendantBindings:!0}},update:function(e,n,t,a,r){var s=h.getSettings(n,e);if(s.mode){var u=o.utils.domData.get(e,y);if(!u){var c=o.virtualElements.childNodes(e);u={},"inline"===s.mode?u.view=i.ensureSingleElement(c):"templated"===s.mode&&(u.parts=f(c)),o.virtualElements.emptyNode(e),o.utils.domData.set(e,y,u)}"inline"===s.mode?s.view=u.view.cloneNode(!0):"templated"===s.mode&&(s.parts=u.parts),s.preserveContext=!0}h.compose(e,s,r,!0)}},o.virtualElements.allowedBindings.compose=!0,h});